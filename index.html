<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>WebTerm Access</title>

<style>
body {
    margin: 0;
    background: black;
    color: lime;
    font-family: monospace;
    height: 100vh;
}

.screen {
    display: none;
    height: 100vh;
    width: 100vw;
}

.active {
    display: flex;
}

.center {
    justify-content: center;
    align-items: center;
    flex-direction: column;
}

button, input {
    background: black;
    color: lime;
    border: 1px solid #333;
    padding: 10px;
    font-family: monospace;
    font-size: 14px;
}

button {
    cursor: pointer;
    margin-top: 10px;
}

input {
    width: 300px;
}

small {
    opacity: 0.6;
}

/* Terminal */
header {
    padding: 8px 12px;
    border-bottom: 1px solid #333;
    background: #111;
}

#terminal {
    padding: 10px;
    height: calc(100vh - 90px);
    overflow-y: auto;
    white-space: pre-wrap;
}

#cmd {
    width: 100%;
    box-sizing: border-box;
    border-top: 1px solid #333;
}
</style>
</head>

<body>

<!-- ============ AUTH SCREEN ============ -->

<div id="auth-screen" class="screen center active">
    <h2>üñ•Ô∏è WebTerm Access</h2>
    <p>Authentication Required</p>
    <input id="password" type="password" placeholder="Enter password">
    <button onclick="authenticate()">Access WebTerm</button>
    <small>Local system access</small>
</div>

<!-- ============ WARNING SCREEN ============ -->

<div id="warning-screen" class="screen center">
    <h2>‚ö†Ô∏è Authentication Disabled</h2>
    <p>No password is configured on the server.</p>
    <p>This terminal has <strong>full system access</strong>.</p>
    <button onclick="enterWithoutAuth()">Continue</button>
</div>

<!-- ============ ERROR SCREEN ============ -->

<div id="error-screen" class="screen center">
    <h2>‚ùå Access Denied</h2>
    <p>Authentication failed.</p>
    <button onclick="reset()">Try Again</button>
</div>

<!-- ============ LOST CONNECTION SCREEN ============ -->

<div id="lost-screen" class="screen center">
    <h2>üîå Lost Connection</h2>
    <p>Unable to reach WebTerm Access server.</p>
    <small>Check that the service is running on port 8080.</small>
    <button onclick="location.reload()">Retry</button>
</div>

<!-- ============ TERMINAL SCREEN ============ -->

<div id="terminal-screen" class="screen" style="flex-direction:column;">
    <header>
        <strong>üñ•Ô∏è WebTerm Access</strong>
        <span style="opacity:.6;">‚Äî system terminal</span>
    </header>
    <div id="terminal"></div>
    <input id="cmd" placeholder="WebTerm input‚Ä¶" autofocus>
</div>

<script>
let authToken = "";
let polling = false;

const screens = {
    auth: document.getElementById("auth-screen"),
    warning: document.getElementById("warning-screen"),
    error: document.getElementById("error-screen"),
    lost: document.getElementById("lost-screen"),
    terminal: document.getElementById("terminal-screen")
};

const terminal = document.getElementById("terminal");
const cmd = document.getElementById("cmd");

function show(screen) {
    Object.values(screens).forEach(s => s.classList.remove("active"));
    screens[screen].classList.add("active");
}

function authFetch(url, options = {}) {
    options.headers = options.headers || {};
    if (authToken) {
        options.headers["X-WebTerm-Auth"] = authToken;
    }
    return fetch(url, options);
}

/* ============ AUTH FLOW ============ */

async function authenticate() {
    authToken = document.getElementById("password").value;

    try {
        const res = await authFetch("/webterm/start", {
            method: "POST",
            body: "{}"
        });

        if (res.status === 401) {
            show("error");
            return;
        }

        show("terminal");
        startPolling();

    } catch {
        show("lost");
    }
}

function enterWithoutAuth() {
    authToken = "";
    show("terminal");
    startPolling();
}

function reset() {
    document.getElementById("password").value = "";
    show("auth");
}

/* ============ TERMINAL ============ */

async function startPolling() {
    terminal.textContent += "\n[WebTerm session started]\n";
    polling = true;

    while (polling) {
        try {
            const res = await authFetch("/webterm/output");

            if (res.status === 401) {
                show("error");
                polling = false;
                return;
            }

            const data = await res.json();
            if (data.output) {
                terminal.textContent += data.output;
                terminal.scrollTop = terminal.scrollHeight;
            }

        } catch {
            show("lost");
            polling = false;
            return;
        }

        await new Promise(r => setTimeout(r, 100));
    }
}

cmd.addEventListener("keydown", async e => {
    if (e.key === "Enter") {
        const text = cmd.value;
        cmd.value = "";

        terminal.textContent += "\n$ " + text + "\n";

        try {
            const res = await authFetch("/webterm/input", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ input: text + "\n" })
            });

            if (res.status === 401) {
                show("error");
                polling = false;
            }

        } catch {
            show("lost");
            polling = false;
        }
    }
});

/* ============ INITIAL CHECK ============ */

(async function initialCheck() {
    try {
        const res = await fetch("/webterm/output");
        if (res.status === 401) {
            show("auth");
        } else {
            show("warning");
        }
    } catch {
        show("lost");
    }
})();
</script>

</body>
</html>
